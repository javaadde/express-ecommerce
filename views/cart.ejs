<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Michroma:wght@400&family=Comfortaa:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'off-white': '#fafafa',
                        'off-black': '#1a1a1a',
                        'soft-gray': '#f5f5f5',
                        'dark-gray': '#2a2a2a'
                    },
                     fontFamily: {
                        'michroma': ['Michroma', 'sans-serif'],
                        'comfortaa': ['Comfortaa', 'sans-serif'],
                    }
                }
            }
        }
    </script>

     <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes checkmark {
            0% {
                stroke-dashoffset: 100;
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                stroke-dashoffset: 0;
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        .checkmark-path {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: checkmark 0.6s ease-in-out forwards;
        }
        
        .modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .success-bounce {
            animation: bounceIn 0.5s ease-out forwards;
        }
        
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
    </style>

</head>
<body class="bg-off-white min-h-screen">

     <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 font-michroma">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-off-black rounded-lg flex items-center justify-center">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Cart base -->
                            <path d="M3 3H5L5.4 5M7 13H17L21 5H5.4M7 13L5.4 5M7 13L4.7 15.3C4.3 15.7 4.6 16.5 5.1 16.5H17M17 13V16.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            
                            <!-- Cart wheels -->
                            <circle cx="9" cy="20" r="1" fill="white"/>
                            <circle cx="20" cy="20" r="1" fill="white"/>
                            </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-off-black font-michroma">Shoping Cart</h1>
                </div>
                <button onclick="window.location.href='http://localhost:5000/settings'" class="text-dark-gray hover:text-off-black text-3xl">
                 <i class="fa-solid fa-circle-user"></i> 
                </button>
            </div>
        </div>
    </header>

    <div class="mx-auto p-6 font-comfortaa w-full" id="container">
    

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 w-full">

            <!-- Cart Items -->
            <div class="lg:col-span-2 w-full">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                    <!-- Cart Items Header -->
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-xl font-semibold text-off-black">Cart Items</h2>
                        <p id="itemCount" class="text-sm text-dark-gray mt-1"><%= items.length %> items in your cart</p>
                    </div>

                    <!-- Cart Items List -->
                    <div id="cartItems" class="divide-y divide-gray-100">
                        <!-- Items will be populated here -->
                    </div>

                    <% if(items.length === 0){ %>

                    <!-- Empty Cart State -->
                    <div id="emptyCart" class=" p-12 text-center">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.1 5.4a1 1 0 001 1.2h9.2a1 1 0 001-1.2L15.5 8M7 13v8a2 2 0 002 2h6a2 2 0 002-2v-8"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-500 mb-2">Your cart is empty</h3>
                        <p class="text-gray-400 mb-4">Add some products to get started</p>
                        <button onclick="continueShopping()" class="px-6 py-3 bg-off-black text-off-white rounded-lg hover:bg-dark-gray transition-colors font-medium">
                            Continue Shopping
                        </button>
                    </div>

                    <% }else{ %>

                        <% items.forEach((item) =>{ %>
                        <% subtotal = subtotal + item.price * item.quantity; %>
                        
                       
                    <!-- none empty stage -->
                  <div class="p-6 flex items-center space-x-4 border-[1px] rounded-b-md">

                        <img src="<%= item.url %>" 
                        alt="" 
                        class="w-[25vh] h-45 rounded-lg object-cover bg-soft-gray">
                        
                        <div class="flex-1 pl-12">
                            <h3 class="text-lg font-semibold text-off-black mb-1"><%= item.name %></h3>
                            <p class="text-dark-gray text-sm"><%= item.price%></p>
                        </div>

                        <div class="flex items-center space-x-3">
                            <!-- Quantity Controls -->
                            <div class="flex items-center space-x-2 bg-soft-gray rounded-lg">
                                <button 
                                    value="<%= item.product_id %>"
                                    onclick="decreaseQty(this.value,this.parentNode)"
                                    class="p-2 hover:bg-gray-200 rounded-lg transition-colors"
                                >
                                    <svg class="w-4 h-4 text-dark-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                    </svg>
                                </button>

                                <span class="px-3 py-1 text-off-black font-medium min-w-[2rem] text-center"><%= item.quantity %></span>

                                <button 
                                    value="<%= item.product_id %>"
                                    onclick="increaseQty(this.value)"
                                    class="p-2 hover:bg-gray-200 rounded-lg transition-colors"
                                >
                                    <svg class="w-4 h-4 text-dark-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                </button>
                            </div>

                            <!-- Item Total -->
                            <div class="text-right min-w-[4rem]">
                                <p class="text-lg font-semibold text-off-black"><%= item.price * item.quantity %></p>
                            </div>

                            <!-- Remove Button -->
                            <button 
                                onclick="deleteItem(this.value)"
                                class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors"
                                title="delete cart item"
                                value="<%= item.product_id %>"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>


  
                 <% }) %>
                 <% } %>


                </div>
            </div>


            <!-- Order Summary -->
            <div class="lg:col-span-1 w-fulld">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 sticky top-6">
                    <h2 class="text-xl font-semibold text-off-black mb-6">Order Summary</h2>
                    
                    <div class="space-y-4 mb-6">
                        <div class="flex justify-between text-dark-gray">
                            <span>Subtotal</span>
                            <span id="subtotal">$<%= subtotal %></span>
                        </div>
                        <div class="flex justify-between text-dark-gray">
                            <span>Shipping</span>
                            <span id="shipping">$5.99</span>
                        </div>
                        <div class="flex justify-between text-dark-gray">
                            <span>Tax</span>
                            <span id="tax">$0.00</span>
                        </div>
                        <div class="border-t border-gray-200 pt-4">
                            <div class="flex justify-between text-lg font-bold text-off-black">
                                <span>Total</span>
                               <span> $ <span id="total"><%= subtotal + 5.99 %></span> </span>
                            </div>
                        </div>
                    </div>

                    <!-- Checkout Button -->
                    <button 
                        onclick="proceedToCheckout()"
                        id="checkoutBtn"
                        class="w-full px-6 py-4 bg-off-black text-off-white rounded-xl hover:bg-dark-gray transition-colors font-semibold text-lg mb-4"
                    >
                        Proceed to Checkout
                    </button>

                    <!-- Continue Shopping -->
                    <button 
                        onclick="continueShopping()"
                        class="w-full px-6 py-3 bg-white text-off-black border-2 border-off-black rounded-xl hover:bg-soft-gray transition-colors font-medium"
                    >
                        Continue Shopping
                    </button>
                </div>
            </div>


        </div>
    </div>



    <!-- first modal -->
    
    <section class="hidden absolute left-auto lg:left-[10%] xl:left-[20%] top-0  items-center justify-center p-9 font-comfortaa" id="paymentDiv">

        

         <!-- Delivery Form -->
            <div class="lg:col-span-2">
                <button onclick="proceedCancel()" class="absolute text-2xl right-12 top-12 w-10 h-10 rounded-full bg-black text-white">x</button>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h2 class="text-xl font-semibold text-off-black mb-6">Shipping Information</h2>
                    
                    <form id="deliveryForm" class="space-y-6">
                       
                        <!-- Name & Phone Row -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div>
                            <label class="block text-sm font-semibold text-dark-gray mb-2">Full Name</label>
                            <input 
                                type="text" 
                                name="name"
                                placeholder="Full name"
                                class="w-full px-4 py-3 bg-soft-gray border-2 border-transparent rounded-lg text-off-black focus:outline-none focus:border-off-black focus:bg-white transition-all"
                                required
                            >
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-dark-gray mb-2">Phone Number</label>
                                <input 
                                    type="tel" 
                                    name="phone"
                                    placeholder="+1 (555) 123-4567"
                                    class="w-full px-4 py-3 bg-soft-gray border-2 border-transparent rounded-lg text-off-black focus:outline-none focus:border-off-black focus:bg-white transition-all"
                                    required
                                >
                            </div>
                        </div>

                        <!-- Street Address -->
                        <div>
                            <label class="block text-sm font-semibold text-dark-gray mb-2">Street Address</label>
                            <input 
                                type="text" 
                                name="streetAddress"
                                placeholder="123 Main Street"
                                class="w-full px-4 py-3 bg-soft-gray border-2 border-transparent rounded-lg text-off-black focus:outline-none focus:border-off-black focus:bg-white transition-all"
                                required
                            >
                        </div>

                        <!-- Apartment/Unit (Optional) -->
                        <div>
                            <label class="block text-sm font-semibold text-dark-gray mb-2">Apartment, Suite, Unit (Optional)</label>
                            <input 
                                type="text" 
                                name="apartment"
                                placeholder="Apt 4B, Suite 100, Unit 5, etc."
                                class="w-full px-4 py-3 bg-soft-gray border-2 border-transparent rounded-lg text-off-black focus:outline-none focus:border-off-black focus:bg-white transition-all"
                            >
                        </div>

                        <!-- City, State, ZIP Row -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-dark-gray mb-2">City</label>
                                <input 
                                    type="text" 
                                    name="city"
                                    placeholder="Mumbai"
                                    class="w-full px-4 py-3 bg-soft-gray border-2 border-transparent rounded-lg text-off-black focus:outline-none focus:border-off-black focus:bg-white transition-all"
                                    required
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-dark-gray mb-2">State</label>
                                <select 
                                    name="state"
                                    class="w-full px-4 py-3 bg-soft-gray border-2 border-transparent rounded-lg text-off-black focus:outline-none focus:border-off-black focus:bg-white transition-all"
                                    required
                                >
                                    <option value="">Select State</option>
                                    <option value="NY">Kerala</option>
                                    <option value="CA">Mumbai</option>
                                    <option value="TX">Panjab</option>
                                    <option value="FL">Goa</option>
                                    <option value="IL">Delhi</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-dark-gray mb-2">Pin Code</label>
                                <input 
                                    type="text" 
                                    name="pinCode"
                                    placeholder="676122"
                                    class="w-full px-4 py-3 bg-soft-gray border-2 border-transparent rounded-lg text-off-black focus:outline-none focus:border-off-black focus:bg-white transition-all"
                                    required
                                >
                            </div>
                        </div>

                        <!-- Country -->
                        <div>
                            <label class="block text-sm font-semibold text-dark-gray mb-2">Country</label>
                            <input 
                                readonly
                                value="india"
                                placeholder="India"
                                name="country"
                                class="w-full px-4 py-3 bg-soft-gray border-2 border-transparent rounded-lg text-off-black focus:outline-none focus:border-off-black focus:bg-white transition-all"
                                required
                            >
                        </div>

                        <!-- Delivery Instructions -->
                        <div>
                            <label class="block text-sm font-semibold text-dark-gray mb-2">Delivery Instructions (Optional)</label>
                            <textarea 
                                name="deliveryInstructions"
                                placeholder="Leave at front door, Ring doorbell, Call upon arrival, etc."
                                rows="3"
                                class="w-full px-4 py-3 bg-soft-gray border-2 border-transparent rounded-lg text-off-black focus:outline-none focus:border-off-black focus:bg-white transition-all resize-none"
                            ></textarea>
                        </div>

                     <!--  Payment -->
                            <div class="lg:col-span-1">
                                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 sticky top-6">
                                    <h2 class="text-xl font-semibold text-off-black mb-6">Payment</h2>


                                    <!-- Payment Button -->
                                    <input
                                        id="submitBtn"
                                        onsubmit=""
                                        type="submit"
                                        value="pay"
                                        class="cursor-pointer w-full px-6 py-4 bg-off-black text-off-white rounded-xl hover:bg-dark-gray transition-colors font-semibold text-lg mb-4 flex items-center justify-center space-x-2"
                                    >
                                    

                                    <!-- Security Note -->
                                    <div class="text-xs text-center text-dark-gray">
                                        <div class="flex items-center justify-center space-x-1 mb-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                            </svg>
                                            <span>Secure Payment</span>
                                        </div>
                                        <p>Your payment information is encrypted and secure</p>
                                    </div>
                                </div>
                            </div>

                    </form>
                </div>
            </div>

    </section>


     <!-- second modal -->    
    <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <!-- Modal Content -->
        <div id="modalContent" class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 text-center modal-enter">
            <!-- Loading State -->
            <div id="loadingState">
                <div class="mb-6">
                    <!-- Loading Circle -->
                    <div class="w-20 h-20 border-4 border-gray-200 border-t-off-black rounded-full loading-spinner mx-auto"></div>
                </div>
                <h2 class="text-xl font-semibold text-gray-800 mb-2">Processing Payment</h2>
                <p class="text-gray-600">Please wait while we process your order...</p>
            </div>
            
            <!-- Success State -->
            <div id="successState" class="hidden">
                <div class="mb-6">
                    <!-- Success Circle with Checkmark -->
                    <div class="w-20 h-20 mx-auto success-bounce">
                        <svg class="w-full h-full" viewBox="0 0 80 80" fill="none">
                            <!-- Circle -->
                            <circle 
                                cx="40" 
                                cy="40" 
                                r="36" 
                                stroke="#10B981" 
                                stroke-width="4" 
                                fill="#F0FDF4"
                            />
                            <!-- Checkmark -->
                            <path 
                                d="M25 40L35 50L55 30" 
                                stroke="#10B981" 
                                stroke-width="4" 
                                stroke-linecap="round" 
                                stroke-linejoin="round"
                                class="checkmark-path"
                            />
                        </svg>
                    </div>
                </div>
                <h2 class="text-xl font-semibold text-green-800 mb-2">Order Placed!</h2>
                <p class="text-gray-600 mb-6">Your order has been successfully placed. You will receive a confirmation email shortly.</p>
                
                <!-- Close Button -->
                <button 
                    id="closeBtn"
                    onclick="window.location.href='http://localhost:5000/'" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-300"
                >
                    Continue Shopping
                </button>
            </div>
        </div>
    </div>



    <script>
   


        function continueShopping(){
            window.location.href='http://localhost:5000/products';
        }

        function deleteItem(product_id){
           
            fetch(`http://localhost:5000/cart/delete/${product_id}`,{
                method:'DELETE',
                headers:{
                    'Content-Type':'application/json'
                }
            })
            .then( async(res)=>{
                const data = await res.json()
                showNotification(data.message)
                setTimeout( ()=> {
                    location.reload()
                },1200)
            })
            .catch((err) => {
                console.log(err);
            })

        }


        function increaseQty(pro_id){

            fetch('http://localhost:5000/cart/quantity/increase',{
                method:'PATCH',
                headers:{
                    'Content-Type':'application/json'
                },
                body:JSON.stringify({
                    product_id:pro_id
                }),
            })
            .then( async(res)=>{
                const data = await res.json()
                showNotification(data.message)
                setTimeout( ()=>{
                   location.reload()
                },2200)
            })
            .catch((err)=>{
                console.log(err);
            })

        }

        function decreaseQty(pro_id,node){

            const currentQty = parseInt(node.children[1].innerText)

            if(currentQty <= 1){
                showNotification("you can't do that")
            }
            else{

                 fetch('http://localhost:5000/cart/quantity/decrease',{
                method:'PATCH',
                headers:{
                    'Content-Type':'application/json'
                },
                body:JSON.stringify({
                    product_id:pro_id
                }),
            })
            .then( async(res)=>{
                const data = await res.json()
                showNotification(data.message)
                setTimeout( ()=>{
                   location.reload()
                },2200)
            })
            .catch((err)=>{
                console.log(err);
            })

            }
        


        }

        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'fixed top-6 right-[50%] bg-off-black text-off-white px-8 py-4 rounded-lg shadow-lg z-50 transition-all transform translate-y-[-100%] ease-in-out';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-y-[-100%]');
            }, 100);
            
            // Remove after 2 seconds
            setTimeout(() => {
                notification.classList.add('translate-y-[-100%]');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 2000);
        }


        function proceedToCheckout(){
        console.log('works');
        
          const popup =  document.getElementById('paymentDiv')
          popup.classList.remove('hidden');

          document.getElementById('container').style.opacity = '20%'
          document.querySelector("header").style.opacity = '20%'

        }


        function proceedToPay(subtotal,formData){
          const popup =  document.getElementById('paymentDiv')
          popup.classList.add('hidden');

           document.getElementById('container').style.opacity = '1'
           document.querySelector("header").style.opacity = '1'

           placeOrder(subtotal,formData);

        }

        document.getElementById('deliveryForm').addEventListener("submit",(e)=>{
            e.preventDefault()
            const subtotal = parseInt( document.getElementById('total').innerText )
            console.log(subtotal);
            
            const formData = new FormData(e.target)
            const data = Object.fromEntries(formData.entries());
            console.log(data);
            proceedToPay(subtotal,data);
            
        })

        function proceedCancel(){
              const popup =  document.getElementById('paymentDiv')
          popup.classList.add('hidden');

           document.getElementById('container').style.opacity = '1'
           document.querySelector("header").style.opacity = '1'

        }
       
        function Notify(){

            console.log('ok');
            
        const modalOverlay = document.getElementById('modalOverlay');
        const loadingState = document.getElementById('loadingState');
        const successState = document.getElementById('successState');
        const closeBtn = document.getElementById('closeBtn');

        
            // Show modal
            modalOverlay.classList.remove('hidden');
            loadingState.classList.remove('hidden');
            successState.classList.add('hidden');
            
            // After 1.5 seconds, switch to success state
            setTimeout(() => {
                loadingState.classList.add('hidden');
                successState.classList.remove('hidden');
            }, 1500);
       

        }

        function placeOrder(subtotal,formData){

            console.log(subtotal);
            
            try{

             fetch('http://localhost:5000/cart/order',{
                method:'POST',
                headers:{
                    'Content-Type':'application/json'
                },
                body: JSON.stringify({
                   total:subtotal,
                   address:formData
                })
             })
             .then( async(res) => {
                const data = await res.json()
                console.log(data.message);
        
                Notify();
                clearCart();

             })
             .catch((err)=>{
                console.log(err);
             })



            }
            catch(err){
                console.log(err)
            }
            
        }

        function clearCart(){
            try{
            fetch('http://localhost:5000/cart/clear',{
                method:'PATCH',
                headers:{
                    'Content-Type':'application/json'
                },
             })
             .then( async(res) => {
                const data = await res.json()
                console.log(data.message);
             })
             .catch((err)=>{
                console.log(err);
             })
            }
            catch(err){
                console.log(err)
            }

        }

    </script>
</body>
</html>